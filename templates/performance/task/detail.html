{% extends 'performance/home.html' %}
{% load static %}

{% block add_js %}
    <script src="{% static 'performance/js/task.js' %}"></script>
    <script src="{% static 'performance/js/echarts.common.js' %}"></script>
    <script src="{% static 'performance/js/visualize.js' %}"></script>
{% endblock %}

{% block navigate %}
    <a href="{% url 'perf:task_home' %}">Test Task</a>
{% endblock %}

{% block detail_action %}
    <div style="height: 50px;">
        <div>
            <h3>Test Plan Name:
                <span><a href="{% url 'perf:plan_home' %}?keyWord={{ tasks.plan.name }}">{{ tasks.plan.name }}</a></span>
            </h3>
            <span style="float: right; margin-right: 30px; width: 110px;">
                <a target="_blank" href="{{ tasks.path }}">Download File</a>
            </span>
            {% if tasks.status == 1 %}
                <span style="float: right; margin-right: 30px; width: 42px;">
                    <a>Stop</a>
                </span>
            {% endif %}
            {% if tasks.plan.type == 1 and tasks.status == 1 %}
                <span style="float: right; margin-right: 30px; width: 100px;">
                    <a>Change TPS</a>
                </span>
            {% endif %}
        </div>
    </div>
    <div style="height: 50px; margin-left: 3%;">
        <div class="plan-detail">
            {% if tasks.plan.type == 0 %}
                <label>Fixed Thread Num: </label>
                <span>{{ tasks.plan.target_num }}</span>
            {% else %}
                <label>Target TPS: </label>
                <span>{{ tasks.plan.target_num }}/s</span>
            {% endif %}
        </div>
        {% if tasks.status == 1 %}
            <div class="plan-detail">
        {% else %}
            <div class="plan-detail" style="display: none;">
        {% endif %}
                <label>Current TPS: </label>
                <span>{{ tasks.plan.duration }}/s</span>
            </div>
        <div class="plan-detail">
            <label>StartTime: </label>
            <span>{{ tasks.start_time | date:"Y-m-d H:i:s" }}</span>
        </div>
        {% if tasks.status > 1 %}
            <div class="plan-detail">
        {% else %}
            <div class="plan-detail" style="display: none;">
        {% endif %}
        <!--div class="plan-detail" style="width: 260px;"-->
            <label>EndTime: </label>
            <span>{{ tasks.end_time | date:"Y-m-d H:i:s" }}</span>
        </div>
    </div>
    <div style="height: 50px; margin-left: 3%;">
        <div class="plan-detail">
            <label>Samples: </label>
            <span>{{ tasks.samples }}</span>
        </div>
        <div class="plan-detail">
            <label>Average TPS: </label>
            <span>{{ tasks.tps }}/s</span>
        </div>
        <div class="plan-detail">
            <label>RT(avg): </label>
            <span>{{ tasks.average_rt }} ms</span>
        </div>
        <div class="plan-detail">
            <label>RT(min): </label>
            <span>{{ tasks.min_rt }} ms</span>
        </div>
        <div class="plan-detail">
            <label>RT(max): </label>
            <span>{{ tasks.max_rt }} ms</span>
        </div>
        <div class="plan-detail">
            <label>Error(%): </label>
            <span>{{ tasks.error }}%</span>
        </div>
    </div>
{% endblock %}
{% block other_content %}
    <div><h3>Monitor Figure</h3>
        <input id="start-time" value="{{ tasks.start_time }}" style="display: none;">
    </div>
    <div id="figure" style="width: 100%;height:480px;margin: 0 auto;"></div>
    <div style="margin-top: 20px;">
        <h3>Pressure Server <span id="total-server" style="font-size: medium; font-weight: normal;"></span></h3>
        <span style="float: right; margin-right: 30px;">
            <a id="show-server" target="_blank" style="text-decoration: none; cursor: pointer; color: blue;">Show more</a>
        </span>
    </div>
{% endblock %}
{% block table_head %}
    <tr class="table_style">
        <th width="15%">Server</th>
        <th width="8%">TPS</th>
        <th width="10%">CPU</th>
        <th width="10%">Memory</th>
        <th width="10%">Disks</th>
        <th width="8%">Network</th>
        <th width="21%">Actions</th>
    </tr>
{% endblock %}
{% block table_body %}
{% endblock %}
{% block define_js %}
    <script type="text/javascript">
        let W = window.screen.width;
        let startTime = document.getElementById('start-time').value;
        document.getElementsByClassName('toolbar')[0].style.width = (W - 200) + 'px';
        document.getElementsByClassName('detail')[0].style.width = (W * 0.99 - 200) + 'px';
        plot({{ tasks.id }}, '{% url 'perf:task_query' %}');
        get_running_server({{ tasks.id }}, '{% url 'perf:get_running_server' %}');
        {% if tasks.status == 1 %}
            if(startTime) {
                let timer = setInterval(function () {
                    plot_delta({{ tasks.id }}, '{% url 'perf:task_query' %}', startTime)
                }, 10000);
            }
            let query_server_timer = setInterval(function () {
                get_running_server({{ tasks.id }}, '{% url 'perf:get_running_server' %}')
            }, 15000);
        {% endif %}

        document.getElementById('show-server').addEventListener('click', function () {
            let title = document.getElementById('show-server').innerText;
            if (title === 'Show more') {
                get_idle_server({{ tasks.server_room.id }}, '{% url 'perf:get_idle_server' %}');
                document.getElementById('show-server').innerText = "Show less";
            } else {
                let trs = document.getElementById('tbody').getElementsByClassName('idling');
                let trs_length = trs.length;
                for(let i=0; i<trs_length; i++) {
                    trs[0].remove();
                }
                document.getElementById('show-server').innerText = "Show more";
            }
        })
    </script>
{% endblock %}
